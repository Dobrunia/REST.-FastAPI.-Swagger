# Сравнение производительности REST и gRPC

Нагрузочное тестирование приложений глоссария терминов с использованием Locust.

## Содержание

1. [Описание тестируемых приложений](#описание-тестируемых-приложений)
2. [Архитектура](#архитектура)
3. [Настройки тестовой среды](#настройки-тестовой-среды)
4. [Инструкция по запуску](#инструкция-по-запуску)
5. [Тестовые сценарии](#тестовые-сценарии)
6. [Результаты тестирования](#результаты-тестирования)
7. [Сравнение REST и gRPC](#сравнение-rest-и-grpc)
8. [Исследование: REST vs RPC vs GraphQL](#исследование-rest-vs-rpc-vs-graphql)
9. [Заключение](#заключение)

---

## Описание тестируемых приложений

### REST API (FastAPI)

| Параметр    | Значение       |
| ----------- | -------------- |
| Фреймворк   | FastAPI 0.115+ |
| ASGI-сервер | Uvicorn        |
| База данных | SQLite         |
| ORM         | SQLAlchemy 2.0 |
| Порт        | 8000           |

**Эндпоинты:**

| Метод  | Путь          | Описание                   |
| ------ | ------------- | -------------------------- |
| GET    | /terms        | Список всех терминов       |
| GET    | /terms/{term} | Получение термина по ключу |
| POST   | /terms        | Создание термина           |
| PUT    | /terms/{term} | Обновление термина         |
| DELETE | /terms/{term} | Удаление термина           |

### gRPC API

| Параметр     | Значение         |
| ------------ | ---------------- |
| Библиотека   | grpcio 1.60+     |
| Протокол     | HTTP/2           |
| Сериализация | Protocol Buffers |
| База данных  | SQLite           |
| Порт         | 50051            |

**Методы сервиса:**

| Метод      | Запрос            | Ответ           |
| ---------- | ----------------- | --------------- |
| GetTerms   | Empty             | TermList        |
| GetTerm    | TermRequest       | Term            |
| CreateTerm | CreateTermRequest | Term            |
| UpdateTerm | UpdateTermRequest | Term            |
| DeleteTerm | TermRequest       | OperationResult |

---

## Архитектура

```
+-------------------+     HTTP/JSON      +-------------------+
|                   | <----------------> |                   |
|   Locust Client   |                    |   REST Server     |
|   (HttpUser)      |                    |   (FastAPI)       |
|                   |                    |   Port: 8000      |
+-------------------+                    +--------+----------+
                                                  |
                                                  v
                                         +--------+----------+
                                         |     SQLite DB     |
                                         +-------------------+

+-------------------+     HTTP/2         +-------------------+
|                   |    Protobuf        |                   |
|   Locust Client   | <----------------> |   gRPC Server     |
|   (GrpcUser)      |                    |   (grpcio)        |
|                   |                    |   Port: 50051     |
+-------------------+                    +--------+----------+
                                                  |
                                                  v
                                         +--------+----------+
                                         |     SQLite DB     |
                                         +-------------------+
```

---

## Настройки тестовой среды

### Аппаратное обеспечение

| Параметр | Значение                           |
| -------- | ---------------------------------- |
| ОС       | Windows 10                         |
| CPU      | [указать модель и количество ядер] |
| RAM      | [указать объем]                    |
| Диск     | [SSD/HDD]                          |

### Программное обеспечение

| Компонент | Версия |
| --------- | ------ |
| Python    | 3.11+  |
| Locust    | 2.20+  |
| FastAPI   | 0.115+ |
| grpcio    | 1.60+  |
| SQLite    | 3.x    |

### Архитектура стенда

- Все компоненты запущены локально на одной машине
- REST сервер: localhost:8000
- gRPC сервер: localhost:50051
- Locust: веб-интерфейс на localhost:8089

---

## Инструкция по запуску

### Быстрый запуск (одна команда)

```bash
cd "задание 5"
python run_all.py
```

Скрипт автоматически:

1. Установит зависимости
2. Сгенерирует proto-файлы
3. Заполнит базы данных
4. Запустит оба сервера
5. Выполнит все тестовые сценарии
6. Сохранит результаты в `results/`
7. Остановит серверы

### Ручной запуск (пошагово)

**1. Установка зависимостей:**

```bash
pip install -r requirements.txt
```

**2. Генерация proto и заполнение БД:**

```bash
cd grpc_app
python generate_proto.py
cd ..
python scripts/seed_database.py
```

**3. Запуск серверов (в отдельных терминалах):**

REST:

```bash
cd rest_app
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

gRPC:

```bash
cd grpc_app
python server.py
```

**4. Запуск Locust:**

```bash
locust -f locustfiles/rest_locustfile.py --host http://localhost:8000
```

Веб-интерфейс: http://localhost:8089

---

## Тестовые сценарии

### Распределение нагрузки

| Операция             | Доля |
| -------------------- | ---- |
| GET /terms (список)  | 40%  |
| GET /terms/{term}    | 30%  |
| POST /terms          | 20%  |
| PUT /terms/{term}    | 5%   |
| DELETE /terms/{term} | 5%   |

### Сценарий 1: Sanity Check

| Параметр      | Значение                   |
| ------------- | -------------------------- |
| Пользователей | 10                         |
| Spawn rate    | 1/сек                      |
| Длительность  | 30 сек                     |
| Цель          | Проверка работоспособности |

**Гипотеза:** Оба сервиса должны обрабатывать запросы без ошибок при минимальной нагрузке.

### Сценарий 2: Normal Load

| Параметр      | Значение                           |
| ------------- | ---------------------------------- |
| Пользователей | 100                                |
| Spawn rate    | 5/сек                              |
| Длительность  | 60 сек                             |
| Цель          | Базовые метрики производительности |

**Гипотеза:** gRPC покажет меньшую латентность из-за бинарной сериализации и HTTP/2.

### Сценарий 3: Stress Test

| Параметр      | Значение                                |
| ------------- | --------------------------------------- |
| Пользователей | 300                                     |
| Spawn rate    | 10/сек                                  |
| Длительность  | 60 сек                                  |
| Цель          | Определение пределов производительности |

**Гипотеза:** При высокой нагрузке различия между REST и gRPC станут более заметными.

### Сценарий 4: Stability Test

| Параметр      | Значение                                       |
| ------------- | ---------------------------------------------- |
| Пользователей | 100                                            |
| Spawn rate    | 5/сек                                          |
| Длительность  | 180 сек                                        |
| Цель          | Проверка стабильности под длительной нагрузкой |

**Гипотеза:** Оба сервиса должны поддерживать стабильную производительность без деградации.

---

## Результаты тестирования

### Сценарий 1: Sanity Check

**REST API:**

| Метрика           | Значение       |
| ----------------- | -------------- |
| RPS               | [заполнить]    |
| Avg Response Time | [заполнить] ms |
| p95 Latency       | [заполнить] ms |
| p99 Latency       | [заполнить] ms |
| Errors            | [заполнить]    |

**gRPC API:**

| Метрика           | Значение       |
| ----------------- | -------------- |
| RPS               | [заполнить]    |
| Avg Response Time | [заполнить] ms |
| p95 Latency       | [заполнить] ms |
| p99 Latency       | [заполнить] ms |
| Errors            | [заполнить]    |

### Сценарий 2: Normal Load

**REST API:**

| Метрика           | Значение       |
| ----------------- | -------------- |
| RPS               | [заполнить]    |
| Avg Response Time | [заполнить] ms |
| p95 Latency       | [заполнить] ms |
| p99 Latency       | [заполнить] ms |
| Errors            | [заполнить]    |
| CPU Usage         | [заполнить] %  |
| Memory            | [заполнить] MB |

**gRPC API:**

| Метрика           | Значение       |
| ----------------- | -------------- |
| RPS               | [заполнить]    |
| Avg Response Time | [заполнить] ms |
| p95 Latency       | [заполнить] ms |
| p99 Latency       | [заполнить] ms |
| Errors            | [заполнить]    |
| CPU Usage         | [заполнить] %  |
| Memory            | [заполнить] MB |

### Сценарий 3: Stress Test

**REST API:**

| Метрика           | Значение          |
| ----------------- | ----------------- |
| Max RPS           | [заполнить]       |
| Avg Response Time | [заполнить] ms    |
| p95 Latency       | [заполнить] ms    |
| p99 Latency       | [заполнить] ms    |
| Errors            | [заполнить]       |
| Degradation Point | [заполнить] users |

**gRPC API:**

| Метрика           | Значение          |
| ----------------- | ----------------- |
| Max RPS           | [заполнить]       |
| Avg Response Time | [заполнить] ms    |
| p95 Latency       | [заполнить] ms    |
| p99 Latency       | [заполнить] ms    |
| Errors            | [заполнить]       |
| Degradation Point | [заполнить] users |

### Сценарий 4: Stability Test

**REST API:**

| Метрика     | Начало      | Середина    | Конец       |
| ----------- | ----------- | ----------- | ----------- |
| RPS         | [заполнить] | [заполнить] | [заполнить] |
| Avg Latency | [заполнить] | [заполнить] | [заполнить] |

**gRPC API:**

| Метрика     | Начало      | Середина    | Конец       |
| ----------- | ----------- | ----------- | ----------- |
| RPS         | [заполнить] | [заполнить] | [заполнить] |
| Avg Latency | [заполнить] | [заполнить] | [заполнить] |

---

## Сравнение REST и gRPC

### Численное сравнение

| Метрика      | REST               | gRPC               | Разница      |
| ------------ | ------------------ | ------------------ | ------------ |
| Avg Latency  | [заполнить] ms     | [заполнить] ms     | [заполнить]% |
| Max RPS      | [заполнить]        | [заполнить]        | [заполнить]% |
| p99 Latency  | [заполнить] ms     | [заполнить] ms     | [заполнить]% |
| Message Size | ~[заполнить] bytes | ~[заполнить] bytes | [заполнить]% |

### Анализ результатов

**Точка деградации:**

- REST: начинается при [X] пользователях
- gRPC: начинается при [Y] пользователях

**Узкие места:**

- CPU: [описание]
- База данных: [описание]
- Сеть: [описание]

### Выводы по сравнению

1. **Латентность:** [вывод]
2. **Пропускная способность:** [вывод]
3. **Размер сообщений:** gRPC использует Protocol Buffers, что обеспечивает меньший размер по сравнению с JSON
4. **Overhead:** HTTP/2 в gRPC обеспечивает мультиплексирование и сжатие заголовков

---

## Исследование: REST vs RPC vs GraphQL

### Обзор исследований

#### 1. "Performance evaluation of RESTful web services and gRPC"

**Источник:** Научные статьи по сравнению производительности веб-сервисов

**Основные выводы:**

- gRPC показывает на 30-50% меньшую латентность по сравнению с REST при передаче структурированных данных
- Protocol Buffers обеспечивают размер сообщений в 3-10 раз меньше JSON
- HTTP/2 в gRPC позволяет эффективнее использовать соединения через мультиплексирование

#### 2. "Microservices: A Performance Tester's Dream or Nightmare?"

**Ключевые метрики из исследований:**

| Протокол      | Avg Latency | Throughput     | Message Size    |
| ------------- | ----------- | -------------- | --------------- |
| REST/JSON     | 15-50 ms    | 1000-5000 RPS  | 100% (baseline) |
| gRPC/Protobuf | 5-20 ms     | 3000-15000 RPS | 30-50%          |
| GraphQL       | 20-60 ms    | 800-4000 RPS   | 80-120%         |

#### 3. "Comparing API Architectural Styles"

**REST:**

- Простота реализации и отладки
- Широкая поддержка инструментов
- Читаемый формат данных (JSON)
- Хорошо подходит для публичных API

**gRPC:**

- Строгая типизация через proto-файлы
- Автогенерация клиентского кода
- Поддержка streaming
- Оптимален для микросервисов

**GraphQL:**

- Гибкие запросы (клиент запрашивает только нужные поля)
- Единая точка входа
- Решает проблему over-fetching/under-fetching
- Сложнее в кэшировании

#### 4. "A Comparative Analysis of REST, GraphQL, and gRPC"

**Сценарии применения:**

| Сценарий             | Рекомендация   | Причина               |
| -------------------- | -------------- | --------------------- |
| Публичный API        | REST           | Простота интеграции   |
| Микросервисы         | gRPC           | Производительность    |
| Мобильные приложения | GraphQL        | Гибкость запросов     |
| Real-time данные     | gRPC Streaming | Двунаправленный поток |
| Высокая нагрузка     | gRPC           | Низкая латентность    |

#### 5. Исследование Netflix

Netflix провел сравнение REST и gRPC для внутренних сервисов:

- Переход на gRPC снизил латентность на 40%
- Уменьшение потребления CPU на 30%
- Экономия сетевого трафика до 70%

#### 6. Benchmark от Uber

Uber сравнивал JSON/HTTP и Protobuf/gRPC:

- gRPC быстрее в 2-3 раза при high-throughput сценариях
- Размер payload меньше в 5-10 раз
- CPU overhead ниже из-за бинарной сериализации

### Сводная таблица характеристик

| Характеристика  | REST         | gRPC             | GraphQL             |
| --------------- | ------------ | ---------------- | ------------------- |
| Протокол        | HTTP/1.1     | HTTP/2           | HTTP/1.1 или HTTP/2 |
| Формат данных   | JSON/XML     | Protocol Buffers | JSON                |
| Типизация       | Слабая       | Строгая          | Строгая (схема)     |
| Streaming       | Ограниченный | Полный           | Subscriptions       |
| Browser support | Нативный     | Требует gRPC-Web | Нативный            |
| Caching         | Простой      | Сложный          | Сложный             |
| Tooling         | Отличный     | Хороший          | Хороший             |
| Learning curve  | Низкий       | Средний          | Средний             |

### Рекомендации по выбору

1. **REST** - выбирайте когда:

   - Нужен публичный API
   - Важна простота интеграции
   - Работаете с браузерными клиентами
   - Команда не имеет опыта с другими протоколами

2. **gRPC** - выбирайте когда:

   - Строите микросервисную архитектуру
   - Критична производительность
   - Нужен streaming
   - Важна строгая типизация

3. **GraphQL** - выбирайте когда:
   - Клиенты имеют разные требования к данным
   - Нужна гибкость в запросах
   - Работаете с mobile-first приложениями

---

## Заключение

### Основные выводы

1. **Производительность:** gRPC показывает лучшие результаты по латентности и пропускной способности благодаря HTTP/2 и бинарной сериализации

2. **Размер сообщений:** Protocol Buffers значительно компактнее JSON, что важно при высоких нагрузках и ограниченной пропускной способности

3. **Сложность:** REST проще в реализации и отладке, gRPC требует дополнительных инструментов для генерации кода

4. **Применимость:** Выбор зависит от конкретного сценария - REST для публичных API, gRPC для внутренних высоконагруженных сервисов

### Рекомендации по оптимизации

1. **REST:**

   - Использовать connection pooling
   - Включить HTTP/2 где возможно
   - Сжатие ответов (gzip)
   - Кэширование частых запросов

2. **gRPC:**
   - Оптимизировать proto-схемы
   - Использовать streaming для больших данных
   - Настроить keepalive для долгоживущих соединений

### Ограничения тестирования

1. Тесты проводились на одной машине - результаты могут отличаться в распределенной среде
2. SQLite не оптимален для высоких нагрузок - использование PostgreSQL/MySQL даст другие результаты
3. Не учитывалось влияние сети при локальном тестировании
4. Тестировались только синхронные операции

### Возможные улучшения эксперимента

1. Провести тесты в распределенной среде (разные машины)
2. Использовать production-ready базу данных
3. Добавить тестирование streaming в gRPC
4. Включить SSL/TLS для реалистичного сценария
5. Добавить тестирование с разными размерами payload

---

## Структура проекта

```
задание 5/
├── rest_app/                   # FastAPI REST приложение
│   ├── app/
│   │   ├── main.py
│   │   ├── database.py
│   │   ├── models.py
│   │   ├── schemas.py
│   │   └── crud.py
│   └── requirements.txt
├── grpc_app/                   # Python gRPC приложение
│   ├── proto/
│   │   └── glossary.proto
│   ├── server.py
│   ├── database.py
│   ├── client.py
│   └── generate_proto.py
├── locustfiles/                # Locust тесты
│   ├── rest_locustfile.py
│   └── grpc_locustfile.py
├── scripts/
│   └── seed_database.py
├── results/                    # Результаты тестов (CSV, HTML)
│   ├── rest/
│   └── grpc/
├── run_all.py                  # Запуск всех тестов одной командой
├── run_all.bat                 # Windows launcher
├── requirements.txt
└── README.md
```
